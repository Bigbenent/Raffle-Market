  <script>
    // Dark / Light Mode (kept intact but slightly hardened)
    const body=document.body, toggleBtn=document.getElementById("modeToggle");
    function applyMode(mode){
      body.classList.remove('dark-mode','light-mode');
      body.classList.add(mode + '-mode');
      toggleBtn.textContent=(mode==="dark")?"üåô Dark":"‚òÄÔ∏è Light";
      localStorage.setItem("mode",mode);
    }
    toggleBtn.addEventListener("click",()=>{
      const current = body.classList.contains("dark-mode") ? "dark" : "light";
      applyMode(current === "dark" ? "light" : "dark");
    });
    applyMode(localStorage.getItem("mode") || "dark");

    // ---------- SAMPLE DATA ----------
    const drawsSample = [
      { id:1, owner:'Sunrise Supermarket', category:'supermarket', product:'Bag of Rice (50kg)', market_price:50000, ticket_price:1000, slots_sold:28, start_time:Date.now(), end_time:Date.now()+48*3600*1000, image:'Rice', status:'active' },
      { id:2, owner:'Prime Electronics', category:'electronics', product:'Samsung 43\u201d Smart TV', market_price:150000, ticket_price:2000, slots_sold:80, start_time:Date.now(), end_time:Date.now()+48*3600*1000, image:'TV', status:'active' },
      { id:3, owner:'Golden Hotel', category:'supermarket', product:'Weekend Stay Voucher', market_price:80000, ticket_price:2000, slots_sold:10, start_time:Date.now(), end_time:Date.now()+48*3600*1000, image:'Hotel', status:'active' }
    ];

    const staticPast = [
      { draw_id: 101, product: 'Bag of Rice (50kg)', owner: 'Sunrise Supermarket', winner_name: 'John', winning_ticket: 50, status: 'won', time: Date.now() - 5*24*3600*1000 },
      { draw_id: 102, product: 'Samsung 43" Smart TV', owner: 'Prime Electronics', winner_name: 'Mary', winning_ticket: 150, status: 'won', time: Date.now() - 3*24*3600*1000 },
      { draw_id: 103, product: 'Weekend Stay Voucher', owner: 'Golden Hotel', winner_name: null, winning_ticket: 40, status: 'no_winner', time: Date.now() - 2*24*3600*1000 }
    ];

    const STORAGE_KEY = 'raffle_bootstrap_state_v1';
    let state = loadState();

    function loadState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw) return JSON.parse(raw);
      const d = drawsSample.map(dr => ({...dr, required_slots: Math.ceil(dr.market_price / dr.ticket_price)}));
      const winners = staticPast.map(p => ({
        draw_id: p.draw_id,
        product: p.product,
        owner: p.owner,
        winner_name: p.winner_name,
        winning_ticket: p.winning_ticket,
        status: p.status,
        time: p.time
      }));
      const init = { draws: d, tickets: [], winners };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(init));
      return init;
    }

    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    // local time display
    function updateLocalTime(){ document.getElementById('local-time').textContent = new Date().toLocaleString(); }
    setInterval(updateLocalTime,1000);
    updateLocalTime();

    // render listing & winners
    const listingEl = document.getElementById('listing');
    const winnersGrid = document.getElementById('winners-grid');

    function render(){
      listingEl.innerHTML = '';
      winnersGrid.innerHTML = '';
      const cat = document.getElementById('category') ? document.getElementById('category').value : 'all';

      // Active draws
      const active = state.draws.filter(d => d.status === 'active' && (cat === 'all' || d.category === cat));
      if(active.length === 0){
        listingEl.innerHTML = '<div class="col-12"><div class="p-3 small small-muted">No active draws found.</div></div>';
      } else {
        active.forEach(d => {
          const required = d.required_slots || Math.ceil(d.market_price / d.ticket_price);
          const sold = d.slots_sold || 0;
          const remaining = Math.max(required - sold, 0);
          const progress = Math.min(100, Math.round((sold/required) * 100));

          const col = document.createElement('div');
          col.className = 'col-sm-6 col-lg-4';
          col.innerHTML = `
            <div class="card card-theme h-100">
              <div class="card-body d-flex flex-column">
                <div class="d-flex gap-3">
                  <div class="flex-shrink-0 product-image" style="width:96px;height:96px;border-radius:10px;background:#061224;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted)">${escapeHtml(d.image)}</div>
                  <div class="flex-grow-1">
                    <h6 class="mb-1">${escapeHtml(d.product)}</h6>
                    <div class="small small-muted">${escapeHtml(d.owner)} ‚Ä¢ Market ‚Ç¶${numberWithCommas(d.market_price)}</div>
                    <div class="d-flex gap-2 align-items-center mt-2">
                      <div class="ticket-price">‚Ç¶${numberWithCommas(d.ticket_price)}</div>
                      <div class="odds-badge">Odds: ${calcOdds(required, sold)}</div>
                    </div>
                  </div>
                </div>

                <div class="mt-3">
                  <div class="progress" style="height:12px;border-radius:12px;background:rgba(255,255,255,0.03)">
                    <div class="progress-bar" role="progressbar" style="width:${progress}%" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                  <div class="d-flex justify-content-between small small-muted mt-2">
                    <div>${sold}/${required} sold</div>
                    <div>‚Ç¶${numberWithCommas(sold * d.ticket_price)}</div>
                  </div>
                </div>

                <div class="mt-3 d-flex align-items-center justify-content-between mt-auto">
                  <div class="fw-bold text-warning" id="cd-${d.id}">--</div>
                  <div>
                    <button class="btn btn-sm btn-outline-light detail-btn me-1" data-id="${d.id}">Details</button>
                    <button class="btn btn-warning btn-sm buy-btn" data-id="${d.id}">Buy Ticket</button>
                  </div>
                </div>

                <div class="mt-3 d-flex flex-wrap" id="balls-${d.id}"></div>
              </div>
            </div>
          `;
          listingEl.appendChild(col);

          // render balls preview
          const ballsWrap = col.querySelector(`#balls-${d.id}`);
          const preview = Math.min(6, sold);
          for(let i = sold - preview + 1; i <= sold; i++){
            if(i <= 0) continue;
            const ball = document.createElement('div');
            ball.className = 'lottery-ball';
            ball.textContent = i;
            ballsWrap.appendChild(ball);
          }

          // start countdown
          startCountdown(d.id, d.end_time);
        });
      }

      // Past winners ‚Äî show static + dynamic winners
      if(state.winners.length === 0){
        winnersGrid.innerHTML = '<div class="col-12"><div class="p-3 small small-muted">No winners yet.</div></div>';
      } else {
        state.winners.slice().reverse().forEach(w => {
          const col = document.createElement('div');
          col.className = 'col-sm-6 col-lg-4';
          if(!w.winner_name){
            col.innerHTML = `
              <div class="card card-theme h-100">
                <div class="card-body">
                  <h6>${escapeHtml(w.product)}</h6>
                  <div class="small small-muted">Owner: ${escapeHtml(w.owner)}</div>
                  <div class="mt-2 text-danger">‚ùå No winner ‚Äî Only ${w.winning_ticket} slots sold</div>
                </div>
              </div>
            `;
          } else {
            const firstName = String(w.winner_name).split(' ')[0];
            col.innerHTML = `
              <div class="card card-theme h-100">
                <div class="card-body">
                  <div class="d-flex gap-3">
                    <div style="width:96px;height:96px;border-radius:10px;background:#061224;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted)">${escapeHtml(w.product)}</div>
                    <div>
                      <h6>${escapeHtml(w.product)}</h6>
                      <div class="small small-muted">Winner: ${escapeHtml(firstName)} ‚Ä¢ Ticket #${w.winning_ticket}</div>
                      <div class="small small-muted mt-1">Owner: ${escapeHtml(w.owner)}</div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }
          winnersGrid.appendChild(col);
        });
      }
    }

    // helper: escape HTML
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
    }

    // odds calc (simple)
    function calcOdds(required, sold){
      const remaining = Math.max(required - sold, 0);
      if(remaining === 0) return 'Closed';
      if(remaining <= 5) return 'Hot ‚Äî close!';
      return `1 in ${remaining}`;
    }

    // countdowns
    const timers = {};
    function startCountdown(id, end){
      const el = document.getElementById('cd-' + id);
      if(!el) return;
      if(timers[id]) clearInterval(timers[id]);
      timers[id] = setInterval(() => {
        const now = Date.now();
        const diff = end - now;
        if(diff <= 0){
          clearInterval(timers[id]);
          el.textContent = 'Expired';
          handleExpiry(id);
          return;
        }
        el.textContent = formatDuration(diff);
      }, 500);
    }

    function formatDuration(ms){
      const s = Math.floor(ms/1000);
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const sec = s%60;
      return `${pad(h)}h ${pad(m)}m ${pad(sec)}s`;
    }
    function pad(n){ return String(n).padStart(2,'0'); }

    function handleExpiry(id){
      const d = state.draws.find(x => x.id === id);
      if(!d) return;
      const required = d.required_slots || Math.ceil(d.market_price / d.ticket_price);
      if(d.slots_sold >= required){
        declareWinnerIfReady(d);
      } else {
        // mark as failed and auto-restart copy
        d.status = 'failed';
        saveState();
        const newId = Math.max(...state.draws.map(x => x.id)) + 1;
        const copy = {...d, id:newId, slots_sold:0, start_time:Date.now(), end_time:Date.now()+48*3600*1000, status:'active'};
        state.draws.push(copy);
        saveState();
        render();
      }
    }

    // buy ticket modal flow (kept function names and behaviour)
    let activeDrawId = null;
    let qty = 1;
    const buyModalEl = document.getElementById('buyModal');
    const bsBuyModal = new bootstrap.Modal(buyModalEl);

    // details modal
    const detailsModalEl = document.getElementById('detailsModal');
    const bsDetailsModal = new bootstrap.Modal(detailsModalEl);

    document.addEventListener('click', e => {
      if(e.target.matches('.buy-btn')){
        const id = Number(e.target.dataset.id);
        openBuyModal(id);
      }
      if(e.target.matches('.detail-btn')){
        const id = Number(e.target.dataset.id);
        openDetailsModal(id);
      }
    });

    // qty buttons
    document.getElementById('qty-inc').addEventListener('click', () => { setQty(qty + 1); });
    document.getElementById('qty-dec').addEventListener('click', () => { setQty(Math.max(1, qty - 1)); });
    document.getElementById('pay-btn').addEventListener('click', () => simulatePayment(activeDrawId, qty));

    // details modal buy button -> opens buy modal
    document.getElementById('details-buy-btn').addEventListener('click', () => {
      if(currentDetailsId) openBuyModal(currentDetailsId);
    });

    let currentDetailsId = null;
    function openDetailsModal(id){
      currentDetailsId = id;
      const d = state.draws.find(x => x.id === id);
      if(!d) return;
      document.getElementById('details-title').textContent = `Details ‚Äî ${d.product}`;
      const req = d.required_slots || Math.ceil(d.market_price / d.ticket_price);
      const body = `
        <div class="small small-muted mb-2">Owner: ${escapeHtml(d.owner)}</div>
        <div class="d-flex justify-content-between mb-2">
          <div><div class="small small-muted">Ticket Price</div><div class="fw-bold text-warning">‚Ç¶${numberWithCommas(d.ticket_price)}</div></div>
          <div><div class="small small-muted">Slots</div><div class="fw-bold">${Math.max(req - d.slots_sold,0)} / ${req}</div></div>
        </div>
        <div class="small small-muted">Market value: ‚Ç¶${numberWithCommas(d.market_price)}</div>
      `;
      document.getElementById('details-body').innerHTML = body;

      // balls
      const ballsWrap = document.getElementById('details-balls');
      ballsWrap.innerHTML = '';
      for(let i=1;i<=d.slots_sold;i++){
        const b = document.createElement('div'); b.className='lottery-ball'; b.textContent = i; ballsWrap.appendChild(b);
      }

      bsDetailsModal.show();
    }

    function openBuyModal(id){
      activeDrawId = id; qty = 1; setQty(1);
      const d = state.draws.find(x => x.id === id);
      document.getElementById('modal-title').textContent = `Buy Tickets ‚Äî ${d.product}`;
      document.getElementById('modal-product').innerHTML = `<div class="small small-muted">Owner: ${d.owner}</div>`;
      document.getElementById('modal-price').textContent = `‚Ç¶${numberWithCommas(d.ticket_price)}`;
      const req = d.required_slots || Math.ceil(d.market_price / d.ticket_price);
      document.getElementById('modal-remaining').textContent = `${Math.max(req - d.slots_sold,0)} / ${req}`;
      updateTotal();
      bsBuyModal.show();
    }

    function setQty(v){
      qty = v;
      document.getElementById('qty').textContent = qty;
      updateTotal();
    }

    function updateTotal(){
      if(!activeDrawId) return;
      const d = state.draws.find(x => x.id === activeDrawId);
      document.getElementById('modal-total').textContent = `‚Ç¶${numberWithCommas(d.ticket_price * qty)}`;
    }

    function simulatePayment(drawId, amount){
      const d = state.draws.find(x => x.id === drawId);
      if(!d) { alert('Invalid draw'); return; }
      const required = d.required_slots || Math.ceil(d.market_price / d.ticket_price);
      const remaining = Math.max(required - d.slots_sold, 0);
      if(amount > remaining){ alert('Cannot buy more tickets than remaining slots'); return; }

      const assigned = [];
      for(let i = 0; i < amount; i++){
        const slotNumber = d.slots_sold + 1;
        const ticket = { id: state.tickets.length + 1, draw_id: d.id, user_id: 'guest', slot_number: slotNumber, purchase_time: Date.now() };
        state.tickets.push(ticket);
        d.slots_sold += 1;
        assigned.push(slotNumber);
      }
      saveState();
      render();
      bsBuyModal.hide();

      // show assigned tickets (keeps behaviour)
      alert(`Payment successful! Tickets assigned: ${assigned.join(', ')}`);

      // check winner condition
      if(d.slots_sold >= required){
        declareWinner(d, 'Guest User', assigned[assigned.length - 1]);
      }
    }

    function declareWinner(draw, winnerName, winningTicketNumber){
      const w = { draw_id: draw.id, product: draw.product, owner: draw.owner, winner_name: winnerName, winning_ticket: winningTicketNumber, time: Date.now(), status: 'won' };
      state.winners.push(w);
      draw.status = 'completed';
      saveState();
      render();
      showWinnerBanner(w);
    }

    function declareWinnerIfReady(d){
      const required = d.required_slots || Math.ceil(d.market_price / d.ticket_price);
      if(d.slots_sold >= required){
        const winTicket = d.slots_sold;
        declareWinner(d, 'Guest User', winTicket);
      }
    }

    function showWinnerBanner(w){
      fireConfetti();
      setTimeout(() => {
        alert(`üéâ Winner announced!\nProduct: ${w.product}\nWinner: ${w.winner_name}\nTicket #: ${w.winning_ticket}`);
      }, 300);
    }

    function fireConfetti(){
      const conf = document.getElementById('confetti'); conf.innerHTML = ''; conf.style.display = 'block';
      const colors = ['#F97316','#FBBF24','#06B6D4','#10B981','#EF4444'];
      for(let i=0;i<80;i++){
        const s = document.createElement('span');
        s.style.position = 'absolute';
        s.style.left = Math.random()*100 + '%';
        s.style.top = Math.random()*100 + '%';
        s.style.width = '10px';
        s.style.height = '16px';
        s.style.opacity = '0.95';
        s.style.background = colors[Math.floor(Math.random()*colors.length)];
        s.style.transform = `rotate(${Math.random()*360}deg)`;
        conf.appendChild(s);
      }
      setTimeout(()=>{ conf.style.display='none'; conf.innerHTML=''; }, 3500);
    }

    function numberWithCommas(x){ return String(x).replace(/\B(?=(\d{3})+(?!\d))/g, ","); }

    // category filter
    document.getElementById('category').addEventListener('change', render);

    // register/login forms simple front-end behaviour
    document.getElementById('registerSubmit').addEventListener('click', () => { alert('Register clicked ‚Äî integrate backend to create accounts'); document.getElementById('registerModal').querySelector('[data-bs-dismiss]')?.click(); });
    document.getElementById('loginSubmit').addEventListener('click', () => { alert('Login clicked ‚Äî integrate backend to authenticate'); document.getElementById('loginModal').querySelector('[data-bs-dismiss]')?.click(); });

    // initial render
    render();

    // autosave / demo cron: every 5 seconds check for expired draws (prototype)
    setInterval(()=>{
      const now = Date.now();
      state.draws.filter(d => d.status === 'active' && d.end_time <= now).forEach(d => handleExpiry(d.id));
    }, 5000);

  </script>