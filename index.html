<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Raffle Market ‚Äî Demo</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --lottery-size:56px;
      --card-bg-dark: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --muted: #94a3b8;
      font-family: Inter, system-ui, Arial, sans-serif;
    }

    /* Light / dark base */
    body.light-mode { background:#f9fafb; color:#0f172a; }
    body.dark-mode  { background: linear-gradient(180deg,#071027 0%, #071b2a 100%); color:#e6eef6; }

    /* Header */
    .brand-logo { width:56px; height:56px; border-radius:12px; background:linear-gradient(135deg,#fbbf24,#f97316); display:flex; align-items:center; justify-content:center; font-weight:800; color:#071027; }

    /* text helpers */
    .small-muted { color: var(--muted); }
    body.light-mode .small-muted { color:#64748b; }

    /* cards */
    .card-theme {
      background: var(--card-bg-dark);
      border:1px solid rgba(255,255,255,0.03);
      color: inherit;
    }
    body.light-mode .card-theme {
      background: #fff;
      border:1px solid rgba(15,23,42,0.06);
      color: inherit;
    }

    .ticket-price { background:#061224; padding:.35rem .6rem; border-radius:.5rem; color:#fbbf24; font-weight:700; }
    .odds-badge { background:rgba(255,255,255,0.03); padding:.25rem .5rem; border-radius:.5rem; color:var(--muted); font-size:.85rem; }
    body.light-mode .odds-badge { background:rgba(15,23,42,0.03); color:#64748b; }

    .lottery-ball {
      width:var(--lottery-size);
      height:var(--lottery-size);
      border-radius:50%;
      background:linear-gradient(180deg,#fff,#e6e6e6);
      color:#071027;
      display:flex;align-items:center;justify-content:center;font-weight:700;
      box-shadow:0 6px 18px rgba(0,0,0,0.25);
      margin-right:.5rem;margin-bottom:.5rem;
    }
    body.dark-mode .lottery-ball { background: linear-gradient(180deg,#fff,#e6e6e6); color:#071027; }
    body.light-mode .lottery-ball { background: linear-gradient(180deg,#f3f4f6,#e6eef6); color:#071027; }

    footer { margin:28px 0; text-align:center; color:var(--muted); }

    /* responsive tweaks */
    @media (max-width:520px){
      .product-row { flex-direction:column; align-items:flex-start }
      .product-image { width:100%; height:140px }
    }

    .card-theme:hover { transform:translateY(-4px); transition:transform .18s ease; }

    /* modal opacity (darker backdrop) and content contrast */
    .modal-backdrop.show { background: rgba(2,6,23,0.6); } /* darker overlay */
    .modal-content { background: rgba(6,10,22,0.9); color: #fff; }
    body.light-mode .modal-content { background: rgba(255,255,255,0.98); color: #071027; }

    /* small buttons in header */
    .btn-outline-light.custom { border-color: rgba(255,255,255,0.2); color: #fff; }
    body.light-mode .btn-outline-light.custom { border-color: rgba(15,23,42,0.1); color: #0f172a; }

    /* ticket-number small */
    .small-ball { width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#fff;color:#071027;margin:.15rem;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,.15) }
    body.dark-mode .small-ball{ background:#fff;color:#071027 }
    body.light-mode .small-ball{ background:#fff;color:#071027 }

    /* readable text adjustments */
    .card-theme .small-muted{ color: rgba(255,255,255,0.65); }
    body.light-mode .card-theme .small-muted{ color:#64748b; }

  </style>
</head>
<body class="dark-mode">
  <div class="container py-3">
    <!-- Header -->
    <header class="d-flex align-items-center justify-content-between mb-4">
      <div class="d-flex align-items-center gap-3">
        <div class="brand-logo">RF</div>
        <div>
          <div class="h5 mb-0">Raffle Market</div>
          <div class="small small-muted">Lottery-styled draws powered by local businesses</div>
        </div>
      </div>

      <div class="text-end">
        <div class="d-flex align-items-center gap-2 justify-content-end">
          <div class="me-3 text-end">
            <div class="fw-bold text-warning">Welcome, Guest</div>
            <div class="small small-muted">Local time: <span id="local-time"></span></div>
          </div>
          <div class="d-flex gap-2">
            <button id="loginBtn" class="btn btn-sm btn-outline-light custom" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
            <button id="registerBtn" class="btn btn-sm btn-warning text-dark" data-bs-toggle="modal" data-bs-target="#registerModal">Register</button>
            <button id="modeToggle" class="btn btn-sm btn-outline-light custom">üåô Dark</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#active" type="button">üõí Active Draws</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#past" type="button">ü•á Past Winners</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#history" type="button">üìú Ticket History</button>
      </li>
    </ul>

    <!-- Filters -->
    <div class="d-flex align-items-center gap-2 mb-3">
      <select id="category" class="form-select form-select-sm w-auto">
        <option value="all">All Categories</option>
        <option value="supermarket">Supermarkets</option>
        <option value="electronics">Electronics</option>
      </select>
      <div class="ms-auto small small-muted">48-hour draws ‚Ä¢ Last-ticket wins</div>
    </div>

    <!-- Content -->
    <div class="tab-content">
      <!-- Active Draws -->
      <div id="active" class="tab-pane fade show active">
        <div id="listing" class="row g-3"></div>
      </div>

      <!-- Past Draws -->
      <div id="past" class="tab-pane fade">
        <h5 class="text-warning mb-3">Recent Draw Results</h5>
        <div id="winners-grid" class="row g-3"></div>
      </div>

      <!-- Ticket History -->
      <div id="history" class="tab-pane fade">
        <h5 class="text-warning mb-3">Your Ticket History</h5>
        <div id="ticket-history" class="list-group"></div>
      </div>
    </div>

    <footer>Prototype ‚Äî frontend only. Backend & payments to be integrated later.</footer>
  </div>

  <!-- Details Modal -->
  <div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content card-theme text-white">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="details-title">Draw Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="details-body"></div>
          <hr>
          <div id="details-balls" class="d-flex flex-wrap"></div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
          <button id="details-buy-btn" class="btn btn-warning">Buy Tickets</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Buy Modal -->
  <div class="modal fade" id="buyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content card-theme text-white">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="modal-title">Buy Tickets</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="modal-product" class="small small-muted mb-2"></div>
          <div class="d-flex justify-content-between">
            <div>
              <div class="small small-muted">Ticket Price</div>
              <div id="modal-price" class="fw-bold text-warning"></div>
            </div>
            <div>
              <div class="small small-muted">Slots</div>
              <div id="modal-remaining" class="fw-bold"></div>
            </div>
          </div>
          <hr>
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small small-muted">Number of Tickets</div>
              <div class="d-flex align-items-center mt-1">
                <button id="qty-dec" class="btn btn-outline-light btn-sm">-</button>
                <div id="qty" class="px-3">1</div>
                <button id="qty-inc" class="btn btn-outline-light btn-sm">+</button>
              </div>
            </div>
            <div>
              <div class="small small-muted">Total</div>
              <div id="modal-total" class="fw-bold text-warning">‚Ç¶0</div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
          <button id="pay-btn" class="btn btn-success">Simulate Payment</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content card-theme text-white">
        <div class="modal-header border-0">
          <h5 class="modal-title">Create account</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="registerForm">
            <div class="mb-2"><label class="form-label small small-muted">Full name</label><input class="form-control form-control-sm" required /></div>
            <div class="mb-2"><label class="form-label small small-muted">Email</label><input type="email" class="form-control form-control-sm" required /></div>
            <div class="mb-2"><label class="form-label small small-muted">Password</label><input type="password" class="form-control form-control-sm" required /></div>
          </form>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
          <button id="registerSubmit" class="btn btn-warning">Create account</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content card-theme text-white">
        <div class="modal-header border-0">
          <h5 class="modal-title">Login</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-2"><label class="form-label small small-muted">Email</label><input type="email" class="form-control form-control-sm" required /></div>
            <div class="mb-2"><label class="form-label small small-muted">Password</label><input type="password" class="form-control form-control-sm" required /></div>
          </form>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
          <button id="loginSubmit" class="btn btn-warning">Login</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confetti container -->
  <div id="confetti" style="display:none;position:fixed;inset:0;pointer-events:none;z-index:1050"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Data (sample)
    const drawsSample = [
      { id:1, owner:'Sunrise Supermarket', category:'supermarket', product:'Bag of Rice (50kg)', market_price:50000, ticket_price:1000, slots_sold:30, start_time:Date.now(), end_time:Date.now()+48*3600*1000, image:'Rice', status:'active', required_slots:50 },
      { id:2, owner:'Prime Electronics', category:'electronics', product:'Samsung 43\\u201d Smart TV', market_price:150000, ticket_price:2000, slots_sold:75, start_time:Date.now(), end_time:Date.now()+48*3600*1000, image:'TV', status:'active', required_slots:75 },
      { id:3, owner:'Golden Hotel', category:'supermarket', product:'Weekend Stay Voucher', market_price:80000, ticket_price:2000, slots_sold:10, start_time:Date.now(), end_time:Date.now()+48*3600*1000, image:'Hotel', status:'active', required_slots:40 }
    ];

    const staticPast = [
      { draw_id: 101, product: 'Bag of Rice (50kg)', owner: 'Sunrise Supermarket', winner_name: 'John', winning_ticket: 50, status: 'won', time: Date.now() - 5*24*3600*1000 },
      { draw_id: 102, product: 'Samsung 43\" Smart TV', owner: 'Prime Electronics', winner_name: 'Mary', winning_ticket: 150, status: 'won', time: Date.now() - 3*24*3600*1000 },
      { draw_id: 103, product: 'Weekend Stay Voucher', owner: 'Golden Hotel', winner_name: null, winning_ticket: 40, status: 'no_winner', time: Date.now() - 2*24*3600*1000 }
    ];

    const STORAGE_KEY = 'raffle_bootstrap_state_v1';
    let state = loadState();

    function loadState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw) return JSON.parse(raw);
      const d = drawsSample.map(dr => ({...dr}));
      const init = { draws: d, tickets: [], winners: staticPast.slice() };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(init));
      return init;
    }
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    // DOM refs
    const listingEl = document.getElementById('listing');
    const winnersGrid = document.getElementById('winners-grid');
    const historyEl = document.getElementById('ticket-history');
    const modalBuyEl = document.getElementById('buyModal');
    const bsBuyModal = new bootstrap.Modal(modalBuyEl);
    const modalDetailsEl = document.getElementById('detailsModal');
    const bsDetailsModal = new bootstrap.Modal(modalDetailsEl);

    // dark/light mode
    const body = document.body, modeBtn = document.getElementById('modeToggle');
    function applyMode(mode){
      body.classList.remove('dark-mode','light-mode');
      body.classList.add(mode + '-mode');
      modeBtn.textContent = (mode === 'dark') ? 'üåô Dark' : '‚òÄÔ∏è Light';
      localStorage.setItem('mode', mode);
      // tweak header buttons readability
      document.querySelectorAll('.btn-outline-light.custom').forEach(b => {
        if(mode === 'dark') { b.classList.add('btn-outline-light'); b.classList.remove('btn-outline-dark'); }
        else { b.classList.remove('btn-outline-light'); b.classList.add('btn-outline-dark'); }
      });
      // adjust body class itself (for selectors)
      body.classList.remove('dark-mode','light-mode');
      body.classList.add(mode + '-mode');
    }
    modeBtn.addEventListener('click', ()=>{
      const current = body.classList.contains('dark-mode') ? 'dark' : 'light';
      applyMode(current === 'dark' ? 'light' : 'dark');
    });
    applyMode(localStorage.getItem('mode') || 'dark');

    // local time
    function updateLocalTime(){ document.getElementById('local-time').textContent = new Date().toLocaleString(); }
    setInterval(updateLocalTime, 1000);
    updateLocalTime();

    // helpers
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
    function numberWithCommas(x){ return String(x).replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
    function pad(n){ return String(n).padStart(2,'0'); }
    function formatDuration(ms){
      const s = Math.floor(ms/1000);
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const sec = s%60;
      return `${pad(h)}h ${pad(m)}m ${pad(sec)}s`;
    }

    // countdowns registry
    const timers = {};

    function startCountdown(id, end){
      const el = document.getElementById('cd-' + id);
      if(!el) return;
      if(timers[id]) clearInterval(timers[id]);
      timers[id] = setInterval(() => {
        const diff = end - Date.now();
        if(diff <= 0){
          clearInterval(timers[id]);
          el.textContent = 'Expired';
          handleExpiry(id);
          return;
        }
        el.textContent = formatDuration(diff);
      }, 500);
    }

    function handleExpiry(id){
      const d = state.draws.find(x => x.id === id);
      if(!d) return;
      const required = d.required_slots || Math.ceil(d.market_price / d.ticket_price);
      if(d.slots_sold >= required){
        declareWinnerIfReady(d);
      } else {
        // mark failed and create a new copy (rollover)
        d.status = 'failed';
        // record a no-winner past record
        state.winners.push({ draw_id: d.id, product: d.product, owner: d.owner, winner_name: null, winning_ticket: d.slots_sold, status: 'no_winner', time: Date.now() });
        saveState();
        const newId = Math.max(...state.draws.map(x=>x.id)) + 1;
        const copy = {...d, id:newId, slots_sold:0, start_time:Date.now(), end_time:Date.now()+48*3600*1000, status:'active'};
        state.draws.push(copy);
        saveState();
        render();
      }
    }

    // render functions
    function render(){
      renderActive();
      renderWinners();
      renderHistory();
    }

    function renderActive(){
      listingEl.innerHTML = '';
      const cat = document.getElementById('category').value;
      const active = state.draws.filter(d => d.status === 'active' && (cat === 'all' || d.category === cat));
      if(active.length === 0){
        listingEl.innerHTML = '<div class="col-12"><div class="p-3 small small-muted">No active draws found.</div></div>';
        return;
      }
      active.forEach(d => {
        const required = d.required_slots || Math.ceil(d.market_price / d.ticket_price);
        const sold = d.slots_sold || 0;
        const remaining = Math.max(required - sold, 0);
        const progress = Math.min(100, Math.round((sold/required)*100));
        const col = document.createElement('div');
        col.className = 'col-sm-6 col-lg-4';
        col.innerHTML = `
          <div class="card card-theme h-100">
            <div class="card-body d-flex flex-column">
              <div class="d-flex gap-3">
                <div class="flex-shrink-0 product-image" style="width:96px;height:96px;border-radius:10px;background:#061224;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted)">${escapeHtml(d.image || 'Item')}</div>
                <div class="flex-grow-1">
                  <h6 class="mb-1">${escapeHtml(d.product)}</h6>
                  <div class="small small-muted">${escapeHtml(d.owner)} ‚Ä¢ Market ‚Ç¶${numberWithCommas(d.market_price)}</div>
                  <div class="d-flex gap-2 align-items-center mt-2">
                    <div class="ticket-price">‚Ç¶${numberWithCommas(d.ticket_price)}</div>
                    <div class="odds-badge">Odds: ${calcOdds(required, sold)}</div>
                  </div>
                </div>
              </div>

              <div class="mt-3">
                <div class="progress" style="height:12px;border-radius:12px;background:rgba(255,255,255,0.03)">
                  <div class="progress-bar" role="progressbar" style="width:${progress}%" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="d-flex justify-content-between small small-muted mt-2">
                  <div>${sold}/${required} sold</div>
                  <div>‚Ç¶${numberWithCommas(sold * d.ticket_price)}</div>
                </div>
              </div>

              <div class="mt-3 d-flex align-items-center justify-content-between mt-auto">
                <div class="fw-bold text-warning" id="cd-${d.id}">--</div>
                <div>
                  <button class="btn btn-sm btn-outline-light detail-btn me-1" data-id="${d.id}">Details</button>
                  <button class="btn btn-warning btn-sm buy-btn" data-id="${d.id}" ${remaining===0? 'disabled':''}>Buy Ticket</button>
                </div>
              </div>

              <div class="mt-3 d-flex flex-wrap" id="balls-${d.id}"></div>
            </div>
          </div>
        `;
        listingEl.appendChild(col);

        // render balls preview (show last up to 6 sold numbers)
        const ballsWrap = col.querySelector(`#balls-${d.id}`);
        const startBall = Math.max(1, d.slots_sold - 5);
        for(let i = startBall; i <= d.slots_sold; i++){
          const ball = document.createElement('div');
          ball.className = 'lottery-ball';
          ball.textContent = i;
          ballsWrap.appendChild(ball);
        }

        // start countdown
        startCountdown(d.id, d.end_time);
      });
    }

    function calcOdds(required, sold){
      const remaining = Math.max(required - sold, 0);
      if(remaining === 0) return 'Closed';
      if(remaining <= 5) return 'Hot ‚Äî close!';
      return `1 in ${remaining}`;
    }

    function renderWinners(){
      winnersGrid.innerHTML = '';
      if(!state.winners || state.winners.length === 0){
        winnersGrid.innerHTML = '<div class="col-12"><div class="p-3 small small-muted">No winners yet.</div></div>';
        return;
      }
      state.winners.slice().reverse().forEach(w => {
        const col = document.createElement('div');
        col.className = 'col-sm-6 col-lg-4';
        if(!w.winner_name){
          col.innerHTML = `
            <div class="card card-theme h-100">
              <div class="card-body">
                <h6>${escapeHtml(w.product)}</h6>
                <div class="small small-muted">Owner: ${escapeHtml(w.owner)}</div>
                <div class="mt-2 text-danger">‚ùå No winner ‚Äî Only ${w.winning_ticket} slots sold</div>
              </div>
            </div>
          `;
        } else {
          const firstName = String(w.winner_name).split(' ')[0];
          col.innerHTML = `
            <div class="card card-theme h-100">
              <div class="card-body">
                <div class="d-flex gap-3">
                  <div style="width:96px;height:96px;border-radius:10px;background:#061224;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted)">${escapeHtml(w.product)}</div>
                  <div>
                    <h6>${escapeHtml(w.product)}</h6>
                    <div class="small small-muted">Winner: ${escapeHtml(firstName)} ‚Ä¢ Ticket #${w.winning_ticket}</div>
                    <div class="small small-muted mt-1">Owner: ${escapeHtml(w.owner)}</div>
                  </div>
                </div>
              </div>
            </div>
          `;
        }
        winnersGrid.appendChild(col);
      });
    }

    function renderHistory(){
      historyEl.innerHTML = '';
      if(!state.tickets || state.tickets.length === 0){
        historyEl.innerHTML = '<div class="p-3 small small-muted">No ticket purchases yet.</div>';
        return;
      }
      // show most recent first
      state.tickets.slice().reverse().forEach(t => {
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        item.innerHTML = `<div><div class="fw-bold">${escapeHtml(t.product)}</div><div class="small small-muted">Ticket #${t.slot_number} ‚Ä¢ Purchased ${new Date(t.purchase_time).toLocaleString()}</div></div><div class="badge bg-secondary">Draw #${t.draw_id}</div>`;
        historyEl.appendChild(item);
      });
    }

    // buy flow
    let activeDrawId = null;
    let qty = 1;

    document.addEventListener('click', e => {
      if(e.target.matches('.buy-btn')){
        const id = Number(e.target.dataset.id);
        openBuyModal(id);
      }
      if(e.target.matches('.detail-btn')){
        const id = Number(e.target.dataset.id);
        openDetailsModal(id);
      }
    });

    document.getElementById('qty-inc').addEventListener('click', () => { setQty(qty + 1); });
    document.getElementById('qty-dec').addEventListener('click', () => { setQty(Math.max(1, qty - 1)); });
    document.getElementById('pay-btn').addEventListener('click', () => simulatePayment(activeDrawId, qty));

    // details modal -> buy button
    document.getElementById('details-buy-btn').addEventListener('click', () => {
      if(currentDetailsId) openBuyModal(currentDetailsId);
    });

    let currentDetailsId = null;
    function openDetailsModal(id){
      currentDetailsId = id;
      const d = state.draws.find(x => x.id === id);
      if(!d) return;
      document.getElementById('details-title').textContent = `Details ‚Äî ${d.product}`;
      const req = d.required_slots || Math.ceil(d.market_price / d.ticket_price);
      const body = `
        <div class="small small-muted mb-2">Owner: ${escapeHtml(d.owner)}</div>
        <div class="d-flex justify-content-between mb-2">
          <div><div class="small small-muted">Ticket Price</div><div class="fw-bold text-warning">‚Ç¶${numberWithCommas(d.ticket_price)}</div></div>
          <div><div class="small small-muted">Slots</div><div class="fw-bold">${Math.max(req - d.slots_sold,0)} / ${req}</div></div>
        </div>
        <div class="small small-muted">Market value: ‚Ç¶${numberWithCommas(d.market_price)}</div>
      `;
      document.getElementById('details-body').innerHTML = body;

      // balls
      const ballsWrap = document.getElementById('details-balls');
      ballsWrap.innerHTML = '';
      for(let i=1;i<=d.slots_sold;i++){
        const b = document.createElement('div'); b.className='lottery-ball'; b.textContent = i; ballsWrap.appendChild(b);
      }
      bsDetailsModal.show();
    }

    function openBuyModal(id){
      activeDrawId = id;
      qty = 1; setQty(1);
      const d = state.draws.find(x => x.id === id);
      document.getElementById('modal-title').textContent = `Buy Tickets ‚Äî ${d.product}`;
      document.getElementById('modal-product').innerHTML = `<div class="small small-muted">Owner: ${escapeHtml(d.owner)}</div>`;
      document.getElementById('modal-price').textContent = `‚Ç¶${numberWithCommas(d.ticket_price)}`;
      const req = d.required_slots || Math.ceil(d.market_price / d.ticket_price);
      document.getElementById('modal-remaining').textContent = `${Math.max(req - d.slots_sold,0)} / ${req}`;
      updateTotal();
      bsBuyModal.show();
    }

    function setQty(v){
      qty = v;
      document.getElementById('qty').textContent = qty;
      updateTotal();
    }
    function updateTotal(){
      if(!activeDrawId) return;
      const d = state.draws.find(x => x.id === activeDrawId);
      document.getElementById('modal-total').textContent = `‚Ç¶${numberWithCommas(d.ticket_price * qty)}`;
    }

    function simulatePayment(drawId, amount){
      const d = state.draws.find(x => x.id === drawId);
      if(!d) { alert('Invalid draw'); return; }
      const required = d.required_slots || Math.ceil(d.market_price / d.ticket_price);
      const remaining = Math.max(required - d.slots_sold, 0);
      if(amount > remaining){ alert('Cannot buy more tickets than remaining slots'); return; }

      const assigned = [];
      for(let i=0;i<amount;i++){
        const slotNumber = d.slots_sold + 1;
        const ticket = { id: state.tickets.length + 1, draw_id: d.id, user_id: 'guest', slot_number: slotNumber, purchase_time: Date.now(), product: d.product };
        state.tickets.push(ticket);
        d.slots_sold += 1;
        assigned.push(slotNumber);
      }
      saveState();
      render();
      bsBuyModal.hide();

      alert(`Payment successful! Tickets assigned: ${assigned.join(', ')}`);

      if(d.slots_sold >= required){
        declareWinner(d, 'Guest User', assigned[assigned.length - 1]);
      }
    }

    function declareWinner(draw, winnerName, winningTicketNumber){
      const w = { draw_id: draw.id, product: draw.product, owner: draw.owner, winner_name: winnerName, winning_ticket: winningTicketNumber, time: Date.now(), status: 'won' };
      state.winners.push(w);
      draw.status = 'completed';
      saveState();
      render();
      showWinnerBanner(w);
    }

    function declareWinnerIfReady(d){
      const required = d.required_slots || Math.ceil(d.market_price / d.ticket_price);
      if(d.slots_sold >= required){
        declareWinner(d, 'Guest User', d.slots_sold);
      }
    }

    // show confetti + alert
    function showWinnerBanner(w){
      fireConfetti();
      setTimeout(()=> {
        alert(`üéâ Winner announced!\nProduct: ${w.product}\nWinner: ${w.winner_name}\nTicket #: ${w.winning_ticket}`);
      }, 300);
    }

    function fireConfetti(){
      const conf = document.getElementById('confetti'); conf.innerHTML=''; conf.style.display='block';
      const colors = ['#F97316','#FBBF24','#06B6D4','#10B981','#EF4444'];
      for(let i=0;i<80;i++){
        const s = document.createElement('span');
        s.style.position='absolute';
        s.style.left = Math.random()*100 + '%';
        s.style.top = Math.random()*100 + '%';
        s.style.width='10px';
        s.style.height='16px';
        s.style.opacity='0.95';
        s.style.background = colors[Math.floor(Math.random()*colors.length)];
        s.style.transform = `rotate(${Math.random()*360}deg)`;
        conf.appendChild(s);
      }
      setTimeout(()=>{ conf.style.display='none'; conf.innerHTML=''; }, 3500);
    }

    // load + initial render
    document.getElementById('category').addEventListener('change', render);
    document.getElementById('registerSubmit').addEventListener('click', ()=> { alert('Register clicked ‚Äî integrate backend'); document.getElementById('registerModal').querySelector('[data-bs-dismiss]')?.click(); });
    document.getElementById('loginSubmit').addEventListener('click', ()=> { alert('Login clicked ‚Äî integrate backend'); document.getElementById('loginModal').querySelector('[data-bs-dismiss]')?.click(); });

    render();

    // autosave / demo cron: check expired draws every 5s
    setInterval(()=> {
      const now = Date.now();
      state.draws.filter(d => d.status === 'active' && d.end_time <= now).forEach(d => handleExpiry(d.id));
    }, 5000);

  </script>
</body>
</html>
